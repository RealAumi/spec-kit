---
description: 跨 spec.md、plan.md、tasks.md 进行非破坏性一致性与质量分析（任务生成后）。
scripts:
  sh: scripts/bash/check-prerequisites.sh --json --require-tasks --include-tasks
  ps: scripts/powershell/check-prerequisites.ps1 -Json -RequireTasks -IncludeTasks
---

用户输入可由代理直接提供或作为命令参数传入——你**必须**在处理提示前考虑它（如不为空）。

User input:

$ARGUMENTS

目标：在实现前，识别三大核心文档（`spec.md`、`plan.md`、`tasks.md`）中的不一致、重复、歧义和未充分说明项。此命令**必须**在 `/tasks` 成功生成完整 `tasks.md` 后运行。

严格只读：**不得**修改任何文件。输出结构化分析报告。可选提供修正建议（需用户显式同意后才可手动调用后续编辑命令）。

宪法权威：项目宪法（`/memory/constitution.md`）在本分析范围内**不可协商**。如有冲突，自动视为 CRITICAL，必须调整 spec、plan 或 tasks，不能淡化、曲解或无声忽略原则。如需修改原则，须在 `/analyze` 之外单独显式更新宪法。

执行步骤：

1. 从仓库根运行 `{SCRIPT}`，解析 JSON 获取 FEATURE_DIR 和 AVAILABLE_DOCS。推导绝对路径：
   - SPEC = FEATURE_DIR/spec.md
   - PLAN = FEATURE_DIR/plan.md
   - TASKS = FEATURE_DIR/tasks.md
   如缺任一文件，报错并提示用户运行缺失的前置命令。

2. 加载文档：
   - 解析 spec.md 各部分：概述/上下文、功能需求、非功能需求、用户故事、边界情况（如有）。
   - 解析 plan.md：架构/技术选型、数据模型引用、阶段、技术约束。
   - 解析 tasks.md：任务 ID、描述、阶段分组、并行标记 [P]、引用的文件路径。
   - 加载宪法 `/memory/constitution.md` 进行原则校验。

3. 构建内部语义模型：
   - 需求清单：每个功能+非功能需求生成稳定 key（如“用户可上传文件”→`user-can-upload-file`）。
   - 用户故事/动作清单。
   - 任务覆盖映射：将每个任务映射到一个或多个需求/故事（通过关键词/显式引用如 ID 或关键短语推断）。
   - 宪法规则集：提取原则名及所有 MUST/SHOULD 规范性陈述。

4. 检查流程：
   A. 重复检测：
      - 识别近似重复需求，标记表述较差者以便合并。
   B. 歧义检测：
      - 标记缺乏可衡量标准的模糊形容词（如“快”、“可扩展”、“安全”、“直观”、“健壮”）。
      - 标记未解决的占位符（TODO、TKTK、???、<placeholder> 等）。
   C. 未充分说明：
      - 只有动词无对象/结果的需求。
      - 用户故事未与验收标准对齐。
      - 任务引用了 spec/plan 未定义的文件或组件。
   D. 宪法对齐：
      - 任何与 MUST 原则冲突的需求或计划项。
      - 缺失宪法要求的部分或质量门槛。
   E. 覆盖缺口：
      - 没有关联任务的需求。
      - 无映射需求/故事的任务。
      - 非功能需求未在任务中体现（如性能、安全）。
   F. 不一致：
      - 术语漂移（同一概念在不同文件中命名不同）。
      - plan 引用的数据实体在 spec 中缺失（或反之）。
      - 任务顺序矛盾（如集成任务早于基础搭建且无依赖说明）。
      - 冲突需求（如一处要求用 Next.js，另一处要求用 Vue）。

5. 严重性分级：
   - CRITICAL：违反宪法 MUST、缺失核心文档、零覆盖的关键需求。
   - HIGH：重复/冲突需求，安全/性能属性歧义，不可测试的验收标准。
   - MEDIUM：术语漂移、非功能任务缺失、边界情况未充分说明。
   - LOW：表述/风格改进、对执行顺序无影响的小冗余。

6. 输出 Markdown 报告（不写文件），包含：

   ### 规范分析报告
   | ID | 类别 | 严重性 | 位置 | 摘要 | 建议 |
   |----|------|--------|------|------|------|
   | A1 | 重复 | HIGH | spec.md:L120-134 | 两条类似需求... | 合并表述，保留更清晰版本 |
   （每条发现一行，ID 用类别首字母+序号）

   附加小节：
   - 覆盖汇总表：
     | 需求 Key | 有任务？ | 任务 ID | 备注 |
   - 宪法对齐问题（如有）
   - 未映射任务（如有）
   - 指标：
     * 总需求数
     * 总任务数
     * 覆盖率（有任务的需求占比）
     * 歧义数
     * 重复数
     * 严重问题数

7. 报告结尾输出下一步建议：
   - 有 CRITICAL 问题：建议先解决再 `/implement`。
   - 仅 LOW/MEDIUM：可继续，但给出改进建议。
   - 明确命令建议：如“用更精细描述重跑 /specify”、“用 /plan 调整架构”、“手动编辑 tasks.md 增加 'performance-metrics' 覆盖”。

8. 询问用户：“需要我为前 N 个问题建议具体修正方案吗？”（**不要**自动应用）。

行为规则：
- **绝不**修改文件。
- **绝不**臆造缺失部分——如无则报告。
- 保持发现结果确定性：无变更时多次运行结果一致。
- 主表最多 50 条，超出部分汇总说明。
- 若无问题，输出成功报告及覆盖统计并建议继续。

Context: {ARGS}

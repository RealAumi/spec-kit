---
description: 通过最多 5 个高针对性澄清问题，识别当前功能规范中的未充分说明区域，并将答案写回规范。
scripts:
   sh: scripts/bash/check-prerequisites.sh --json --paths-only
   ps: scripts/powershell/check-prerequisites.ps1 -Json -PathsOnly
---

用户输入可由代理直接提供或作为命令参数传入——你**必须**在处理提示前考虑它（如不为空）。

User input:

$ARGUMENTS

目标：检测并减少当前功能规范中的歧义或缺失决策点，并将澄清内容直接记录到规范文件。

注意：本澄清流程应在调用 `/plan` 前运行并完成。如用户明确表示跳过澄清（如探索性 spike），可继续，但需警告下游返工风险增加。

执行步骤：

1. 从仓库根运行 `{SCRIPT}`（`--json --paths-only` 模式），解析 JSON：
   - `FEATURE_DIR`
   - `FEATURE_SPEC`
   - （可选捕获 `IMPL_PLAN`、`TASKS` 以便后续流程）
   - 如 JSON 解析失败，终止并提示用户重跑 `/specify` 或检查分支环境。

2. 加载当前规范文件。按下列分类结构化扫描歧义与覆盖情况，每类标记状态：清晰/部分/缺失。生成内部覆盖映射（如无问题则不输出原始映射）。

   功能范围与行为：
   - 核心用户目标与成功标准
   - 明确声明不在范围内的内容
   - 用户角色/画像区分

   领域与数据模型：
   - 实体、属性、关系
   - 唯一性规则
   - 生命周期/状态流转
   - 数据量/规模假设

   交互与 UX 流程：
   - 关键用户路径/序列
   - 错误/空/加载状态
   - 可访问性或本地化说明

   非功能质量属性：
   - 性能（延迟、吞吐目标）
   - 可扩展性（横向/纵向、上限）
   - 可靠性与可用性（在线率、恢复期望）
   - 可观测性（日志、指标、追踪信号）
   - 安全与隐私（认证/授权、数据保护、威胁假设）
   - 合规/监管约束（如有）

   集成与外部依赖：
   - 外部服务/API 及失败模式
   - 数据导入/导出格式
   - 协议/版本假设

   边界与异常处理：
   - 负面场景
   - 限流/节流
   - 冲突解决（如并发编辑）

   约束与权衡：
   - 技术约束（语言、存储、部署）
   - 明确权衡或被否决的方案

   术语与一致性：
   - 规范术语表
   - 避免同义词/弃用词

   完成信号：
   - 验收标准可测试性
   - 可衡量的完成定义

   其他/占位符：
   - TODO 标记/未决策项
   - 模糊形容词（如“健壮”、“直观”）缺乏量化

   对于状态为部分/缺失的类别，除非澄清不会影响实现/验证策略或更适合规划阶段，否则加入候选问题队列。

3. 内部生成优先级队列（最多 5 个）澄清问题。**不要**一次性全部输出。约束：
    - 全流程最多 5 个问题。
    - 每个问题必须可用如下方式回答：
       * 简短多选（2-5 个互斥选项），或
       * 一词/短语（明确限制“答案≤5字”）。
   - 仅包含答案会实质影响架构、数据建模、任务分解、测试设计、UX 行为、运维或合规验证的问题。
   - 保证类别覆盖均衡，优先高影响未解决类别。
   - 排除已答、风格偏好、仅影响计划细节的问题（除非影响正确性）。
   - 优先减少返工风险或防止验收测试偏差的澄清。
   - 如未解决类别超 5 个，按（影响力*不确定性）优先。

4. 交互式提问循环：
    - 每次只提**一个**问题。
    - 多选题用 Markdown 表格：

       | 选项 | 描述 |
       |------|------|
       | A | <选项A描述> |
       | B | <选项B描述> |
       | C | <选项C描述> |（如需 D/E 最多 5）
       | Short | 其他简短答案（≤5字）|（如适用）

    - 简答题直接输出：`格式：简短答案（≤5字）`
    - 用户答复后：
       * 校验答案是否匹配选项或≤5字。
       * 如歧义，快速澄清（不计新问题数）。
       * 满意后记录，进入下一个问题。
    - 满足以下任一即停止：
       * 关键歧义提前解决（剩余队列作废）
       * 用户主动终止（“done”、“good”、“no more”）
       * 达到 5 个问题
    - **绝不**提前泄露后续问题。
    - 如无有效问题，立即报告“无需正式澄清的关键歧义”，建议继续。

5. 每次采纳答案后集成：
    - 内存中维护规范（初始加载）及原始文件内容。
    - 首次集成时：
       * 确保有 `## Clarifications` 节（如无则在最高级上下文/概述后创建）。
       * 其下创建 `### Session YYYY-MM-DD` 子标题（如无则新建）。
    - 采纳后立即追加：`- Q: <问题> → A: <最终答案>`。
    - 并立即将澄清内容应用到最合适部分：
       * 功能歧义→功能需求
       * 用户/角色→用户故事或 Actors 子节
       * 数据结构→数据模型
       * 非功能约束→非功能/质量属性
       * 边界/异常→边界情况/错误处理
       * 术语冲突→全规范统一，必要时保留原名注释
    - 如澄清使早前歧义无效，替换原表述，避免矛盾。
    - 每次写入后保存规范（原子覆盖）。
    - 保持格式：不重排无关部分，保留标题层级。
    - 每条澄清简明可测（避免叙述漂移）。

6. 校验（每次写入及最终）：
   - 本次 session 下澄清条数=采纳问题数（无重复）。
   - 总提问≤5。
   - 相关部分无遗留模糊占位符。
   - 无矛盾旧表述。
   - Markdown 结构有效，仅允许新标题：`## Clarifications`、`### Session YYYY-MM-DD`。
   - 术语全规范一致。

7. 写回 `FEATURE_SPEC`。

8. 结束时报告：
   - 提问与采纳数
   - 规范路径
   - 涉及部分
   - 覆盖汇总表（每类状态：已解决/延后/清晰/未解决）
   - 如有未解决/延后，建议是否继续 `/plan` 或后续再 `/clarify`
   - 建议下一步命令

行为规则：
- 如无关键歧义，输出“无需正式澄清的关键歧义”，建议继续。
- 如缺规范文件，提示先运行 `/specify`（**不**在此新建）。
- 总提问≤5（同一问题多次澄清不计新问题）。
- 避免无关技术栈问题，除非影响功能清晰。
- 尊重用户终止信号（“stop”、“done”、“proceed”）。
 - 如全覆盖，输出简明覆盖表并建议继续。
 - 如配额用尽仍有高影响未解，延后并说明。

Context for prioritization: {ARGS}
